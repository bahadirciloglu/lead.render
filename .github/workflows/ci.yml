name: "ğŸ”§ Lead Discovery API - Simple CI"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  # Supabase environment variables from GitHub Secrets
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  test:
    name: ğŸ§ª Basic Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "Installing dependencies..."
        pip install -r requirements.txt
        echo "âœ… Dependencies installed"
        
    - name: ğŸ” Check project structure
      run: |
        echo "âœ… Checking project structure..."
        ls -la
        echo "âœ… Main files exist:"
        ls -la main.py Dockerfile render.yaml
        
    - name: ğŸ³ Test Docker build
      run: |
        echo "ğŸ³ Testing Docker build..."
        docker build -t lead-discovery-api:test .
        echo "âœ… Docker build successful"
        
    - name: ğŸ§ª Run basic tests
      run: |
        echo "ğŸ§ª Running basic tests..."
        echo "Environment variables:"
        echo "SUPABASE_URL: $SUPABASE_URL"
        echo "SUPABASE_ANON_KEY: $SUPABASE_ANON_KEY"
        
        python -c "import main; print('âœ… Main module imports successfully')"
        python -c "import supabase_database; print('âœ… Database module imports successfully')"
        python -c "import supabase_auth; print('âœ… Auth module imports successfully')"
        echo "âœ… All basic tests passed"
        
    - name: ğŸ³ Test Docker container startup
      run: |
        echo "ğŸš€ Testing Docker container startup..."
        docker run -d --name test-container -p 8000:8000 \
          -e SUPABASE_URL="$SUPABASE_URL" \
          -e SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY" \
          -e SUPABASE_SERVICE_ROLE_KEY="$SUPABASE_SERVICE_ROLE_KEY" \
          lead-discovery-api:test
        sleep 10
        echo "âœ… Container started successfully"
        
        echo "ğŸ” Testing health endpoint..."
        curl -f http://localhost:8000/api/health || echo "âš ï¸ Health endpoint not ready yet"
        
        echo "ğŸ§¹ Cleaning up test container..."
        docker stop test-container
        docker rm test-container
        echo "âœ… Test container cleanup completed"
        
    - name: ğŸ“„ Test PDF Generation
      run: |
        echo "ğŸ“„ Testing PDF Generation..."
        
        # Start API container for PDF testing
        echo "ğŸš€ Starting API container for PDF testing..."
        docker run -d --name pdf-test-container -p 8000:8000 \
          -e SUPABASE_URL="$SUPABASE_URL" \
          -e SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY" \
          -e SUPABASE_SERVICE_ROLE_KEY="$SUPABASE_SERVICE_ROLE_KEY" \
          lead-discovery-api:test
        sleep 15
        echo "âœ… API container started"
        
        # Wait for API to be ready
        echo "â³ Waiting for API to be ready..."
        for i in {1..30}; do
          if curl -f http://localhost:8000/api/health > /dev/null 2>&1; then
            echo "âœ… API is ready after $i seconds"
            break
          fi
          echo "â³ Attempt $i/30 - API not ready yet..."
          sleep 2
        done
        
        # Create test tender
        echo "ğŸ“ Creating test tender..."
        TENDER_RESPONSE=$(curl -s -X POST http://localhost:8000/api/tenders \
          -H "Content-Type: application/json" \
          -d '{
            "title": "Test Tender for PDF",
            "description": "Test tender description for PDF generation testing",
            "company_name": "Test Company",
            "project_title": "Test Project",
            "budget_range": "50000",
            "total_amount": 50000,
            "deadline": "2024-12-31",
            "requirements": "Test requirements for PDF generation",
            "terms_conditions": "Test terms and conditions",
            "payment_terms": "Test payment terms",
            "delivery_timeline": "Test delivery timeline",
            "contact_info": "test@example.com"
          }')
        
        TENDER_ID=$(echo $TENDER_RESPONSE | jq -r '.tender_id // .id // "test-tender-id"')
        echo "âœ… Test tender created with ID: $TENDER_ID"
        
        # Test English PDF generation
        echo "ğŸ‡ºğŸ‡¸ Testing English PDF generation..."
        curl -f -s -o "tender_en.pdf" "http://localhost:8000/api/tenders/$TENDER_ID/pdf?language=en"
        echo "âœ… English PDF generated"
        
        # Test Turkish PDF generation
        echo "ğŸ‡¹ğŸ‡· Testing Turkish PDF generation..."
        curl -f -s -o "tender_tr.pdf" "http://localhost:8000/api/tenders/$TENDER_ID/pdf?language=tr"
        echo "âœ… Turkish PDF generated"
        
        # Check PDF content for common issues
        echo "ğŸ” Checking PDF content for issues..."
        
        # Install pdfgrep for content checking
        sudo apt-get update -qq
        sudo apt-get install -y pdfgrep
        
        # Check for problematic characters
        echo "âŒ Checking for 'â– ' symbols in English PDF..."
        if pdfgrep -q "â– " tender_en.pdf; then
          echo "âŒ FOUND 'â– ' symbols in English PDF!"
          pdfgrep "â– " tender_en.pdf
          exit 1
        else
          echo "âœ… No 'â– ' symbols found in English PDF"
        fi
        
        echo "âŒ Checking for 'â– ' symbols in Turkish PDF..."
        if pdfgrep -q "â– " tender_tr.pdf; then
          echo "âŒ FOUND 'â– ' symbols in Turkish PDF!"
          pdfgrep "â– " tender_tr.pdf
          exit 1
        else
          echo "âœ… No 'â– ' symbols found in Turkish PDF"
        fi
        
        # Check for proper currency symbols
        echo "ğŸ’° Checking currency symbols..."
        if pdfgrep -q "TL " tender_en.pdf; then
          echo "âœ… Proper 'TL' currency symbol found in English PDF"
        else
          echo "âš ï¸ No 'TL' currency symbol found in English PDF"
        fi
        
        if pdfgrep -q "TL " tender_tr.pdf; then
          echo "âœ… Proper 'TL' currency symbol found in Turkish PDF"
        else
          echo "âš ï¸ No 'TL' currency symbol found in Turkish PDF"
        fi
        
        # Check for empty fields
        echo "ğŸ“‹ Checking for empty fields..."
        if pdfgrep -q "Not specified" tender_en.pdf; then
          echo "âœ… Default values found in English PDF"
        else
          echo "âš ï¸ No default values found in English PDF"
        fi
        
        if pdfgrep -q "BelirtilmemiÅŸ" tender_tr.pdf; then
          echo "âœ… Default values found in Turkish PDF"
        else
          echo "âš ï¸ No default values found in Turkish PDF"
        fi
        
        # Check for proper language content
        echo "ğŸŒ Checking language-specific content..."
        if pdfgrep -q "TENDER PROPOSAL" tender_en.pdf; then
          echo "âœ… English title found in English PDF"
        else
          echo "âŒ English title NOT found in English PDF"
          exit 1
        fi
        
        if pdfgrep -q "TEKLÄ°F SUNUMU" tender_tr.pdf; then
          echo "âœ… Turkish title found in Turkish PDF"
        else
          echo "âŒ Turkish title NOT found in Turkish PDF"
          exit 1
        fi
        
        # Check for emoji characters (should not be present)
        echo "ğŸš« Checking for emoji characters..."
        if pdfgrep -q "ğŸ“‹\|ğŸ“\|ğŸ’¼\|ğŸ“œ\|ğŸ’³\|ğŸšš\|ğŸ“" tender_en.pdf; then
          echo "âŒ FOUND emoji characters in English PDF!"
          pdfgrep "ğŸ“‹\|ğŸ“\|ğŸ’¼\|ï¿½ï¿½\|ğŸ’³\|ğŸšš\|ğŸ“" tender_en.pdf
          exit 1
        else
          echo "âœ… No emoji characters found in English PDF"
        fi
        
        if pdfgrep -q "ğŸ“‹\|ğŸ“\|ğŸ’¼\|ğŸ“œ\|ğŸ’³\|ğŸšš\|ğŸ“" tender_tr.pdf; then
          echo "âŒ FOUND emoji characters in Turkish PDF!"
          pdfgrep "ğŸ“‹\|ğŸ“\|ğŸ’¼\|ï¿½ï¿½\|ğŸ’³\|ğŸšš\|ğŸ“" tender_tr.pdf
          exit 1
        else
          echo "âœ… No emoji characters found in Turkish PDF"
        fi
        
        echo "âœ… All PDF content checks passed!"
        
        # Clean up test tender
        echo "ğŸ§¹ Cleaning up test tender..."
        curl -s -X DELETE "http://localhost:8000/api/tenders/$TENDER_ID" || echo "âš ï¸ Could not delete test tender"
        
        echo "ğŸ§¹ Cleaning up PDF test container..."
        docker stop pdf-test-container
        docker rm pdf-test-container
        echo "âœ… PDF test container cleanup completed"
        
    - name: ï¿½ï¿½ Test Summary
      if: always()
      run: |
        echo "ğŸ“Š Simple CI Test Summary:"
        echo "âœ… Python dependencies installed"
        echo "âœ… Project structure validated"
        echo "âœ… Docker build successful"
        echo "âœ… Basic module tests passed"
        echo "âœ… Container startup test completed"
        echo "âœ… PDF generation tests completed"
        echo "âœ… PDF content validation passed"
        echo "ğŸ¯ All tests passed successfully!"
